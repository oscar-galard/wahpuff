<?php

namespace App\Http\Controllers;

use Inertia\Inertia;
use App\Models\Plan;
use App\Models\Subscription;
use App\Models\Payment;
use App\Models\DiscountCode;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Illuminate\Http\Request;

class PaymentController extends Controller
{
    private string $paypalBaseUrl; // Declarado, pero sin valor
    private string $clientId;
    private string $clientSecret;

    public function __construct()
    {
        $this->clientId = config('services.paypal.client_id');
        $this->clientSecret = config('services.paypal.client_secret');
        
        // ¡¡¡CORRECCIÓN AQUÍ!!!
        // Inicializa paypalBaseUrl en el constructor
        $this->paypalBaseUrl = config('services.paypal.mode') === 'live' 
                             ? 'https://api-m.paypal.com' 
                             : 'https://api-m.sandbox.paypal.com';
    }

    public function showPaymentPage()
    {
        $plans = Plan::all();
        
        // Ya no necesitas asignar $this->paypalBaseUrl aquí
        // porque ya se inicializó en el constructor.
        
        return Inertia::render('PaymentPage', [
            'plans' => $plans,
            'paypalClientId' => config('services.paypal.client_id'),
            'paypalMode' => config('services.paypal.mode'),
            'paypalBaseUrl' => $this->paypalBaseUrl, // Puedes pasarla si la necesitas en el frontend,
                                                     // pero el SDK de PayPal no la necesita para cargarse.
        ]);
    }

    public function createOrder(Request $request)
    {
        $request->validate([
            'plan_id' => 'required|exists:plans,id',
            'discount_code' => 'nullable|string',
        ]);
        
        $plan = Plan::findOrFail($request->plan_id);
        $amount = $plan->price;

        if ($request->discount_code) {
            $discountCode = DiscountCode::where('code', $request->discount_code)->first();
            if ($discountCode && $discountCode->isValid()) {
                // Lógica de descuento real
                if ($discountCode->type === 'percentage') {
                    $amount = $amount * (1 - $discountCode->discount_percentage / 100);
                } elseif ($discountCode->type === 'fixed') {
                    $amount = $amount - $discountCode->discount_amount;
                }
                $amount = max(0, $amount); // Asegura que el precio no sea negativo
            }
        }
        
        try {
            $accessToken = $this->getAccessToken();
            // La URL base ahora está garantizada de estar bien inicializada
            $response = Http::withToken($accessToken)
                ->post("{$this->paypalBaseUrl}/v2/checkout/orders", [
                    'intent' => 'CAPTURE',
                    'purchase_units' => [
                        [
                            'amount' => [
                                'currency_code' => 'MXN',
                                'value' => number_format($amount, 2, '.', ''), // Asegura formato de dos decimales con punto
                            ],
                            'custom_id' => $plan->id, 
                        ],
                    ],
                ]);

            if ($response->successful()) {
                // Aquí es donde el SDK de PayPal espera el 'id' de la orden.
                // Es crucial que devuelvas SOLO el ID de la orden de PayPal.
                return response()->json(['id' => $response->json('id')]); 
            }

            Log::error('PayPal API Error (Create Order):', ['response' => $response->json()]);
            // Devolver un JSON de error válido.
            return response()->json([
                'error' => $response->json('message') ?? 'Error de PayPal al crear la orden.',
                'details' => $response->json() // Para más detalles en el frontend
            ], $response->status());

        } catch (\Exception $e) {
            Log::error('Error al crear orden de PayPal: ' . $e->getMessage());
            return response()->json(['error' => 'Error interno del servidor.', 'message' => $e->getMessage()], 500);
        }
    }

    public function completeOrder(Request $request)
    {
        $request->validate(['orderID' => 'required|string']);

        try {
            $accessToken = $this->getAccessToken();

            // Logging for debugging
            Log::info('Attempting to capture PayPal order', [
                'orderID' => $request->orderID,
                'url' => "{$this->paypalBaseUrl}/v2/checkout/orders/{$request->orderID}/capture"
            ]);

            // La URL base ahora está garantizada de estar bien inicializada
            $response = Http::withToken($accessToken)
                ->withHeaders([
                    'Content-Type' => 'application/json'
                ])
                ->post("{$this->paypalBaseUrl}/v2/checkout/orders/{$request->orderID}/capture", (object)[]);

            if ($response->successful() && $response->json('status') === 'COMPLETED') {
                $transactionId = $response->json('purchase_units.0.payments.captures.0.id');
                $amount = $response->json('purchase_units.0.payments.captures.0.amount.value');
                $planId = $response->json('purchase_units.0.custom_id'); 
                
                $this->createSubscription($request->user(), $planId);
                $this->createPayment($request->user(), $planId, $amount, $transactionId);
                
                return response()->json(['status' => 'success', 'message' => 'Pago exitoso.']);
            }
            
            Log::error('PayPal API Error (Capture Order):', ['response' => $response->json()]);
            return response()->json([
                'error' => $response->json('message') ?? 'No se pudo completar el pago.',
                'details' => $response->json()
            ], $response->status());

        } catch (\Exception $e) {
            Log::error('Error al completar orden de PayPal: ' . $e->getMessage());
            return response()->json(['error' => 'Error interno del servidor.', 'message' => $e->getMessage()], 500);
        }
    }

    private function getAccessToken(): string
    {
        // La URL base ahora está garantizada de estar bien inicializada
        $response = Http::asForm()
            ->withBasicAuth($this->clientId, $this->clientSecret)
            ->post("{$this->paypalBaseUrl}/v1/oauth2/token", [
                'grant_type' => 'client_credentials',
            ]);
        $response->throw(); // Asegúrate de lanzar una excepción si falla la obtención del token
        return $response->json('access_token');
    }

    private function createSubscription($user, $planId)
    {
        Subscription::updateOrCreate(
            ['user_id' => $user->id],
            [
                'plan_id' => $planId,
                'started_at' => now(),
                'expires_at' => now()->addMonth(),
            ]
        );
    }

    private function createPayment($user, $planId, $amount, $transactionId)
    {
        Payment::create([
            'user_id' => $user->id,
            'plan_id' => $planId,
            'amount' => $amount,
            'payment_method' => 'paypal',
            'transaction_id' => $transactionId,
            'successful' => true,
            'paid_at' => now(),
        ]);
    }
}
